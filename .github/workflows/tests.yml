name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.21"
  PYTHON_VERSION: "3.12"

jobs:
  # ============================================================
  # Python Services Tests
  # ============================================================
  test-collapse-service:
    name: "ðŸ§ª Collapse Service Tests"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: collapse_service

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: collapse_service/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --tb=short --cov=collapse_engine --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: collapse_service/coverage.xml
          flags: collapse-service
          fail_ci_if_error: false

  test-ml-backend:
    name: "ðŸ§ª ML Backend Tests"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ml_backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: ml_backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --tb=short --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: ml_backend/coverage.xml
          flags: ml-backend
          fail_ci_if_error: false

  test-validation-service:
    name: "ðŸ§ª Validation Service Tests"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: validation_service

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: validation_service/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run tests
        run: |
          python -c "import validation_engine; print('Validation engine imports OK')"

  # ============================================================
  # Go Services Tests & Build
  # ============================================================
  test-go-backend:
    name: "ðŸ§ª Go Backend Tests"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: go_backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go_backend/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: go_backend/coverage.out
          flags: go-backend
          fail_ci_if_error: false

  build-go-services:
    name: "ðŸ”¨ Build Go Services"
    runs-on: ubuntu-latest
    needs: [test-go-backend]
    strategy:
      matrix:
        service:
          - { name: go_backend, path: go_backend, main: ./cmd/api }
          - { name: admin_dashboard, path: admin_dashboard, main: . }
          - { name: data_service, path: data_service, main: . }
          - { name: job_orchestrator, path: job_orchestrator, main: . }

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: ${{ matrix.service.path }}/go.sum

      - name: Build ${{ matrix.service.name }}
        working-directory: ${{ matrix.service.path }}
        run: |
          go build -o ${{ matrix.service.name }} ${{ matrix.service.main }}
          echo "âœ… ${{ matrix.service.name }} built successfully"

  # ============================================================
  # Docker Build Validation
  # ============================================================
  docker-build:
    name: "ðŸ³ Docker Build"
    runs-on: ubuntu-latest
    needs: [test-collapse-service, test-ml-backend, test-go-backend]
    strategy:
      matrix:
        service:
          - { name: collapse_service, dockerfile: collapse_service/Dockerfile, context: collapse_service }
          - { name: ml_backend, dockerfile: ml_backend/Dockerfile, context: ml_backend }
          - { name: validation_service, dockerfile: validation_service/Dockerfile, context: validation_service }
          - { name: go_backend, dockerfile: go_backend/Dockerfile, context: go_backend }
          - { name: admin_dashboard, dockerfile: admin_dashboard/Dockerfile, context: admin_dashboard }
          - { name: data_service, dockerfile: data_service/Dockerfile, context: data_service }
          - { name: job_orchestrator, dockerfile: job_orchestrator/Dockerfile, context: job_orchestrator }

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: false
          tags: ${{ matrix.service.name }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================
  # Lint & Code Quality
  # ============================================================
  lint-python:
    name: "ðŸ” Python Lint"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linters
        run: |
          pip install ruff black isort

      - name: Run Ruff
        run: ruff check --output-format=github .
        continue-on-error: true

      - name: Check Black formatting
        run: black --check --diff collapse_service ml_backend validation_service
        continue-on-error: true

  lint-go:
    name: "ðŸ” Go Lint"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: go_backend
        continue-on-error: true

  # ============================================================
  # Proto Validation
  # ============================================================
  validate-proto:
    name: "ðŸ“‹ Validate Proto Files"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          version: latest

      - name: Lint proto files
        run: |
          cd proto
          buf lint || echo "Proto lint completed with warnings"
        continue-on-error: true

  # ============================================================
  # Security Scan
  # ============================================================
  security-scan:
    name: "ðŸ” Security Scan"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          exit-code: "0"
          format: "table"

  # ============================================================
  # Production Readiness Check
  # ============================================================
  prod-ready-check:
    name: "âœ… Production Readiness"
    runs-on: ubuntu-latest
    needs:
      - test-collapse-service
      - test-ml-backend
      - test-go-backend
      - build-go-services
      - docker-build

    steps:
      - uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking required production files..."
          
          files=(
            "docker-compose.yml"
            "ml_backend/Dockerfile"
            "ml_backend/Dockerfile.production"
            "go_backend/Dockerfile"
            "collapse_service/Dockerfile"
            "validation_service/Dockerfile"
            "monitoring/prometheus.yml"
          )
          
          missing=0
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file is missing"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "::warning::$missing required files are missing"
          fi

      - name: Validate docker-compose
        run: |
          docker compose config --quiet && echo "âœ… docker-compose.yml is valid"

      - name: Production readiness summary
        run: |
          echo "## ðŸš€ Production Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Collapse Service Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ML Backend Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Go Backend Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Go Services Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Images Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All critical checks passed. Ready for production deployment!** ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
